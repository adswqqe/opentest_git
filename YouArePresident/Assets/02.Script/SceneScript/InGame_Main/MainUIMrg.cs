using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class MainUIMrg : MonoBehaviour
{
    public static MainUIMrg Instance;
  
    public Sprite[] BtnSprite;
    public GameObject[] powerBarSilder = new GameObject[6];
    public Text[] VisitText = new Text[6];
    public Image[] updateMarks = new Image[6];
    public Sprite[] updateing_Sprite = new Sprite[6];
    public Sprite[] noUpdateing_Sprite = new Sprite[6];
    public GameObject powerReport;
    public PowerBtn[] powerbtnScript;
    public GameObject SelectPowerUI;    // 선택 UI
    public GameObject yesNoUI;
    public GameObject letter;           // 편지
    public GameObject letterHead;       // 편지지
    public Text contentsText;           // 편지 내용
    public Image powerMark;
    public Text leaderName;
    public Transform mainCamera;
    public Image EFF;
    public Image BGM;
    Vector3 startVector;
    Vector3 sideVector;
    float smooth = 3.0f;
    bool isSelect = false;

    void Awake()
    {
        if (Instance == null)
            Instance = this;
        else if (Instance != this)
            Destroy(this.gameObject);

        startVector = mainCamera.position;
        sideVector = new Vector3(18.43f, 0f,-10f);

        DataReset();

    }

    void Start()
    {

        if (SoundMrg.Instance.isBGMOff)
            SoundMrg.Instance.StartBGM(0);
        mainCamera.position = startVector;
        Invoke("SetDisplayUI", 0.02f);  // 로딩 때 컨텐츠가 로딩되고 IngameMrg가 퀘스트를 받오기까지의 딜레이를 기다린다.
        if(!DataMrg.dataMrg.isfrist)
        InGameMrg_Main.inGame_mrg_main.CallSetPowerReport();
    }

    public void DataReset()
    {
        for (int i = 0; i < powerBarSilder.Length; i++)
        {
            powerBarSilder[i].transform.localScale = new Vector3(0, 1, 1);
        }
    }

    public void SetDisplayUI()
    {
        letter.active = true;
        SelectPowerUI.SetActive(false);
        yesNoUI.SetActive(true);
        contentsText.text = InGameMrg_Main.inGame_mrg_main.Quest.contents;
        powerMark.sprite = DataMrg.dataMrg.powerInfo[InGameMrg_Main.inGame_mrg_main.Quest.powerNum].powerMark;
        leaderName.text = DataMrg.dataMrg.powerInfo[InGameMrg_Main.inGame_mrg_main.Quest.powerNum].leaderName;
        Debug.Log("PowerNum + " + InGameMrg_Main.inGame_mrg_main.Quest.powerNum);
        DataUIMrg.Instance.setDisplayData();    // 데이터를 다시 Display
        InGameMrg_Main.inGame_mrg_main.ProcessingAnwserData();  // 퀘스트의 데이터 처리를 미리 해두자
    }

    public void OpenLeteer()
    {
        SoundMrg.Instance.StartEFF(0);
        letter.active = false;
        letterHead.active = true;
        SetUpdateMark();
    }

    public void AanswerLetter(bool _answer)
    {
        if (InGameMrg_Main.inGame_mrg_main.Quest.isSelect == "*")
            SetSelectPower();
        else
        {
            SoundMrg.Instance.StartEFF(1);
            InGameMrg_Main.inGame_mrg_main.SetAnwserData(_answer);
            letterHead.active = false;
            MoveCameraLeft();
            SetOffUpdateMark();
        }
    }

    public void SetSelectPower()
    {
        SelectPowerUI.SetActive(true);
        yesNoUI.SetActive(false);
        SetPowerBtnInfo();
    }

    public void SetPowerBtnInfo()
    {
        int count = 0;
        for (int i = 0; i < 6; i++)
        {
            if (int.Parse(InGameMrg_Main.inGame_mrg_main.YupPowerArr[i].ToString()) != int.Parse(InGameMrg_Main.inGame_mrg_main.Quest.YwhatPowerDown))
            {
                if (i == 5)
                    powerbtnScript[count].setBtnInfo(int.Parse(InGameMrg_Main.inGame_mrg_main.YupPowerArr[i].ToString()));
                else
                {
                    powerbtnScript[count].setBtnInfo(int.Parse(InGameMrg_Main.inGame_mrg_main.YupPowerArr[i].ToString()));
                    count++;
                }
            }
            else
            {
                continue;
            }
        }
    }

    public void PowerBtnPress(int _powerIndex)
    {
        SoundMrg.Instance.StartEFF(1);
        letterHead.active = false;
        MoveCameraLeft();
        SetOffUpdateMark();
        // InGameMrg_Main.inGame_mrg_main.selectPowerIndex = _powerIndex;
        Debug.Log("Index : " + _powerIndex);
        InGameMrg_Main.inGame_mrg_main.selectPowerIndex = _powerIndex;
        InGameMrg_Main.inGame_mrg_main.SetAnwserData(true);
    }

    public void LoadPowerScene(int _Num)
    {
        SoundMrg.Instance.StartEFF(2);
        SoundMrg.Instance.FadeBGM(false, 0);
        SceneMrg.sceneMrg.NextScene(_Num);
    }

    // 어떤 세력이 영향 받는지 마크 표시
    public void SetUpdateMark() // 거절하든 수학하든 영향받는 세력들은 모두 이미지 온
    {
        for (int i = 0; i < InGameMrg_Main.inGame_mrg_main.YupPowerArr.Length; i++)
        {
            if(InGameMrg_Main.inGame_mrg_main.YupPowerArr[i] != '\0')
            switch(int.Parse(InGameMrg_Main.inGame_mrg_main.YupPowerArr[i].ToString()))
            {
                    case 0:
                    updateMarks[0].sprite = updateing_Sprite[0];
                        break;

                    case 1:
                        updateMarks[1].sprite = updateing_Sprite[1];
                        break;

                    case 2:
                        updateMarks[2].sprite = updateing_Sprite[2];
                        break;
                    case 3:
                        updateMarks[3].sprite = updateing_Sprite[3];
                        break;

                    case 4:
                        updateMarks[4].sprite = updateing_Sprite[4];
                        break;

                    case 5:
                        updateMarks[5].sprite = updateing_Sprite[5];
                        break;
                }
        }

        for (int i = 0; i < InGameMrg_Main.inGame_mrg_main.YdownPowerArr.Length; i++)
        {
            if (InGameMrg_Main.inGame_mrg_main.YdownPowerArr[i] != '\0')
                switch (int.Parse(InGameMrg_Main.inGame_mrg_main.YdownPowerArr[i].ToString()))
                {
                    case 0:
                        updateMarks[0].sprite = updateing_Sprite[0];
                        break;

                    case 1:
                        updateMarks[1].sprite = updateing_Sprite[1];
                        break;

                    case 2:
                        updateMarks[2].sprite = updateing_Sprite[2];
                        break;
                    case 3:
                        updateMarks[3].sprite = updateing_Sprite[3];
                        break;

                    case 4:
                        updateMarks[4].sprite = updateing_Sprite[4];
                        break;

                    case 5:
                        updateMarks[5].sprite = updateing_Sprite[5];
                        break;
                }

        }
        for (int i = 0; i < InGameMrg_Main.inGame_mrg_main.NupPowerArr.Length; i++)
        {
            if (InGameMrg_Main.inGame_mrg_main.NupPowerArr[i] != '\0')
                switch (int.Parse(InGameMrg_Main.inGame_mrg_main.NupPowerArr[i].ToString()))
                {
                    case 0:
                        updateMarks[0].sprite = updateing_Sprite[0];
                        break;

                    case 1:
                        updateMarks[1].sprite = updateing_Sprite[1];
                        break;

                    case 2:
                        updateMarks[2].sprite = updateing_Sprite[2];
                        break;
                    case 3:
                        updateMarks[3].sprite = updateing_Sprite[3];
                        break;

                    case 4:
                        updateMarks[4].sprite = updateing_Sprite[4];
                        break;

                    case 5:
                        updateMarks[5].sprite = updateing_Sprite[5];
                        break;
                }
        }

        for (int i = 0; i < InGameMrg_Main.inGame_mrg_main.NdownPowerArr.Length; i++)
        {
            if (InGameMrg_Main.inGame_mrg_main.NdownPowerArr[i] != '\0')
                switch (int.Parse(InGameMrg_Main.inGame_mrg_main.NdownPowerArr[i].ToString()))
                {
                    case 0:
                        updateMarks[0].sprite = updateing_Sprite[0];
                        break;

                    case 1:
                        updateMarks[1].sprite = updateing_Sprite[1];
                        break;

                    case 2:
                        updateMarks[2].sprite = updateing_Sprite[2];
                        break;
                    case 3:
                        updateMarks[3].sprite = updateing_Sprite[3];
                        break;

                    case 4:
                        updateMarks[4].sprite = updateing_Sprite[4];
                        break;

                    case 5:
                        updateMarks[5].sprite = updateing_Sprite[5];
                        break;
                }
        }
    
        if (InGameMrg_Main.inGame_mrg_main.Quest.YspendGold >= 1 || InGameMrg_Main.inGame_mrg_main.Quest.YspendGold <= 1 || InGameMrg_Main.inGame_mrg_main.Quest.YspendGold >= 1 || InGameMrg_Main.inGame_mrg_main.Quest.NspendGold <= 1 || InGameMrg_Main.inGame_mrg_main.Quest.NspendGold >= 1)
            updateMarks[6].sprite = updateing_Sprite[6];

        if (InGameMrg_Main.inGame_mrg_main.Quest.YspendDay >= 2 || InGameMrg_Main.inGame_mrg_main.Quest.NspendDay >= 2)
            updateMarks[7].sprite = updateing_Sprite[7];
    }

    public void SetOffUpdateMark()
    {
        for (int i = 0; i < 8; i++)
            updateMarks[i].sprite = noUpdateing_Sprite[i];
    }

    public void SetPowerReport(int _powerIndex, int _spendDay)
    {
        float value = 0.0f;

        for (int i = 0; i < 6; i++)     // 싹다 spendday를 더한뒤 방문한 세력만 1로 초기화
        {
            if (DataMrg.dataMrg.powerInfo[i].isVisit)
            {
                Debug.Log("SpendDay = " + _spendDay);
                DataMrg.dataMrg.powerInfo[i].passDay += _spendDay;
                Debug.Log(DataMrg.dataMrg.powerInfo[i].passDay);
            }
        }
        DataMrg.dataMrg.powerInfo[_powerIndex].passDay = 1;


        value = ((float)(int)(1000 / (float)DataMrg.dataMrg.powerInfo[_powerIndex].maxVolume) * DataMrg.dataMrg.OutData(int.Parse("2" + _powerIndex.ToString()))) / 1000;
        if (value <= 0)
            DataMrg.dataMrg.powerReportData[_powerIndex] = 0;
        else
            DataMrg.dataMrg.powerReportData[_powerIndex] = value;

        for (int i = 0; i < 6; i++)
        {
            powerBarSilder[i].transform.localScale = new Vector3(DataMrg.dataMrg.powerReportData[i], powerBarSilder[i].transform.localScale.y, powerBarSilder[i].transform.localScale.z);
            if (DataMrg.dataMrg.powerInfo[i].isVisit)
                VisitText[i].text = DataMrg.dataMrg.powerInfo[i].passDay.ToString() + "일 전";
        }
    }

    public void ShowPowerReport()
    {
        
        SoundMrg.Instance.StartEFF(5);
        powerReport.active = true;
        if (DataMrg.dataMrg.isfrist)
            DataReset();
    }

    public void ExitPowerReport()
    {
        SoundMrg.Instance.StartEFF(5);
        powerReport.active = false;
    }

    public void MoveCameraLeft()
    {
        StartCoroutine(MoveLeft());
    }
    
    public void SoundOff(bool isBGM)
    {
        if (!isBGM)
        {
            if (SoundMrg.Instance.isEFFOff)
                EFF.sprite = BtnSprite[0];
            else
                EFF.sprite = BtnSprite[1];
        }
        else
        {
            if (SoundMrg.Instance.isBGMOff)
                BGM.sprite = BtnSprite[1];
            else
                BGM.sprite = BtnSprite[0];
        }
        SoundMrg.Instance.StopBGM(isBGM);
    }

    IEnumerator MoveLeft()
    {
        while (mainCamera.position.x <= sideVector.x-0.01)
        {
            mainCamera.transform.position = Vector3.Lerp(new Vector3(mainCamera.transform.position.x,0, mainCamera.transform.position.z), sideVector, Time.deltaTime * smooth);
            yield return new WaitForSeconds(0.005f);
        }
    }
}
